<!DOCTYPE html>
<html>
<head>
	<title>Свояк — Таблица</title>
	<meta charset="utf-8">
	<meta name="author" content="Чукавин Андрей">
	<meta name="description" content="Таблица для ведения счета в любительской Своей Игре">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no">
	<style type="text/css">
		* {
			font-family: Arial;
			padding: 0;
			margin: 0;
		}

		body {
			background: #f0f0f0;
		}

		table#main,
		div#controls table {
			max-width: 500px;
			margin-left: auto;
			margin-right: auto;
		}

		table#main .avatar {
			min-width:	40px;
			min-height:	40px;
			max-width:	40px;
			max-height:	40px;
			border-radius: 5px;
			cursor: pointer;
		}
		table#main .avatar[data-color="blue"] {
			background: #1191CE;
		}
		table#main .avatar[data-color="red"] {
			background: #DA3B35;
		}
		table#main .avatar[data-color="green"] {
			background: #84B73E;
		}
		table#main .avatar[data-color="yellow"] {
			background: #EC9F01;
		}
		table#main .avatar[data-color="blue"]:hover {
			background: #0d75a5;
		}
		table#main .avatar[data-color="red"]:hover {
			background: #ac2420;
		}
		table#main .avatar[data-color="green"]:hover {
			background: #6e9834;
		}
		table#main .avatar[data-color="yellow"]:hover {
			background: #cb8801;
		}

		table#main {
			width: 100%;
			padding: 15px;
			margin-bottom: 200px;
		}
		table#main tr td:first-child {
			width: 10%;
			text-align: center;
			font-weight: bold;
		}
		table#main tr.score[data-question]:hover  {
			background: #ddd;
			cursor: pointer;
		}
		table#main tr.score#current-question {
			background: #ddd;
		}
		table#main tr.score#current-question td {
			font-weight: bold;
		}
		table#main tr th p {
			background: #555;
			color: white;
			padding: 10px;
			border-radius: 5px;
		}
		table#main tr.score {
			line-height: 40px;
		}
		table#main tr.score td {
			text-align: center;
		}
		table#main tr.score[data-question] td {
			border-bottom: 1px solid #ccc;
		}
		table#main tr.score[data-question="4"] td {
			border-bottom: 3px double #ccc;
		}
		table#main tr.score td.positive {
			color: #84B73E;
		}
		table#main tr.score td.negative {
			color: #DA3B35;
		}
		table#main tr.total td {
			margin-bottom: 20px;
			font-weight: bold;
		}
		table tr.spacer {
			height: 30px;
		}
		table tr#grand-total td {
			border-top: 5px double #ccc;
			font-weight: bold;
		}


		#controls {
			background: #aaa;
			position: fixed;
			bottom: 0;
			padding-top: 10px;
			padding-bottom: 10px;
			width: 100%;
		}
		#controls button {
			max-width: 50px;
			min-width: 50px;
			max-height: 50px;
			min-height: 50px;
			background: white;
			border: none;
			border-radius: 10px;
			touch-action: manipulation;
			cursor: pointer;
		}
		#controls #navigation button {
			font-size: 30px;
			font-weight: bold;
		}
		#controls #navigation button:hover {
			background: #ddd;
		}
		#controls #navigation span {
			font-size: 40px;
		}
		#controls #current-subject-number {
			color: #666;
		}
		#controls table {
			table-layout: fixed;
			margin-bottom: 10px;
			width: 100%;
		}
		#controls table tr.spacer {
			height: 10px;
		}

		#controls .action-buttons button {
			display: block;
			font-size: 40px;
		}
		#controls .action-buttons button[data-type='plus'] {
			border-bottom: 1px solid #aaa;
			border-bottom-right-radius: 0;
			border-bottom-left-radius: 0;
			color: #84B73E;
		}
		#controls .action-buttons button[data-type='minus'] {
			border-top-left-radius: 0;
			border-top-right-radius: 0;
			color: #DA3B35;
		}
		#controls .action-buttons button[data-type='plus']:hover {
			background: #e8f2d9;
		}
		#controls .action-buttons button[data-type='minus']:hover {
			background: #f7d5d4;
		}
		#controls .action-buttons button[data-type='plus'].selected {
			background: #84B73E;
			color: white;
		}
		#controls .action-buttons button[data-type='minus'].selected {
			background: #DA3B35;
			color: white;
		}
		#controls .action-buttons button[data-type='plus'].selected:hover {
			background: #6e9834;
		}
		#controls .action-buttons button[data-type='minus'].selected:hover {
			background: #ac2420;
		}

		input {
			background: transparent;
			border: 1px solid transparent;
			border-radius: 5px;
			padding: 5px 0;
			max-width: 70px;
			font-size: 15px;
			text-align: center;
		}
	</style>
	<script type="text/javascript">
		var score = [[], [], [], []]
		var numberOfSubjects = 0

		function addSubject() {
			var subject = numberOfSubjects++

			var table = document.getElementById("questions")

			// Subject Header
			var subjectHeader = document.createElement("tr")
			table.appendChild(subjectHeader)
			var td = document.createElement("th")
			td.setAttribute("colSpan", 5)
			subjectHeader.appendChild(td)
			var p = document.createElement("p")
			p.innerHTML = "Тема " + (subject+1)
			td.appendChild(p)

			// Subject questions
			for(question = 0; question < 5; ++question) {
				var tr = document.createElement("tr")
				tr.setAttribute("class", "score")
				tr.setAttribute("data-subject", subject)
				tr.setAttribute("data-question", question)
				tr.onclick = onRowClicked
				table.appendChild(tr)
				if(subject == 0 && question == 0) {
					tr.setAttribute("id", "current-question")
					onCurrentQuestionChanged(subject, question)
				}

				var td = document.createElement("td")
				tr.appendChild(td)
				td.innerHTML = (question + 1) * 10

				for(player = 0; player < 4; ++player) {
					var td = document.createElement("td")
					td.setAttribute("data-player", player)
					tr.appendChild(td)
				}
			}

			// Subject total
			var totalRow = document.createElement("tr")
			totalRow.setAttribute("class", "score total")
			table.appendChild(totalRow)
			var totalDescription = document.createElement("td")
			totalDescription.innerHTML = "Σ"
			totalRow.appendChild(totalDescription)

			for(player = 0; player < 4; ++player) {
				var td = document.createElement("td")
				td.innerHTML = "0"
				td.setAttribute("data-player", player)
				td.setAttribute("data-subject", subject)
				totalRow.appendChild(td)
			}

			// Spacer
			var spacerRow = document.createElement("tr")
			table.appendChild(spacerRow)
			spacerRow.setAttribute("class", "spacer")
			spacerRow.appendChild(document.createElement("td"))
		}

		function onRowClicked() {
			var currentRow = document.getElementById("current-question")
			if(currentRow == undefined) {
				return
			}

			var subject = parseInt(this.getAttribute("data-subject"))
			var question = parseInt(this.getAttribute("data-question"))

			selectQuestion(subject, question)
		}

		function prevQuestion() {
			let currentRow = document.getElementById("current-question")
			if(currentRow == undefined) {
				return
			}

			let currentSubject = parseInt(currentRow.getAttribute("data-subject"))
			let currentQuestion = parseInt(currentRow.getAttribute("data-question"))

			let prevSubject = currentSubject - (currentQuestion == 0 ? 1 : 0)
			let prevQuestion = (5 + currentQuestion - 1) % 5

			selectQuestion(prevSubject, prevQuestion)
		}

		function nextQuestion() {
			let currentRow = document.getElementById("current-question")
			if(currentRow == undefined) {
				return
			}

			let currentSubject = parseInt(currentRow.getAttribute("data-subject"))
			let currentQuestion = parseInt(currentRow.getAttribute("data-question"))

			let nextSubject = currentSubject + (currentQuestion == 4 ? 1 : 0)
			let nextQuestion = (currentQuestion + 1) % 5

			if(nextSubject == numberOfSubjects) {
				addSubject()
				window.scrollTo(0, document.body.scrollHeight);
			}

			selectQuestion(nextSubject, nextQuestion)
		}

		function selectQuestion(subject, question) {
			let currentRow = document.getElementById("current-question")

			let scoreTrs = document.getElementsByClassName("score")
			for(let i = 0; i < scoreTrs.length; ++i) {
				let scoreTr = scoreTrs[i]
				if(scoreTr.getAttribute("data-subject") == subject && scoreTr.getAttribute("data-question") == question) {
					currentRow.setAttribute("id", "")
					scoreTr.setAttribute("id", "current-question")
					onCurrentQuestionChanged(subject, question)
					break
				}
			}
		}

		function onCurrentQuestionChanged(subject, question) {
			document.getElementById("current-subject-number").innerHTML = (subject + 1) + "."
			document.getElementById("current-question-number").innerHTML = (question + 1)*10

			let buttons = document.querySelectorAll(".action-buttons button")
			for(let i = 0; i < buttons.length; ++i) {
				let button = buttons[i]

				let player = parseInt(button.getAttribute("data-player"))
				let buttonMultiplier = button.getAttribute("data-type") == "plus" ? 1 : -1

				let selected = getAnswer(subject, question, player) == buttonMultiplier
				button.setAttribute("class", selected ? "selected" : "")
			}
		}

		function onActionButtonClicked(button) {
			let currentRow = document.getElementById("current-question")
			if(currentRow == undefined) {
				return
			}

			let selected = button.getAttribute("class") == "selected"
			button.setAttribute("class", selected ? "" : "selected")

			let multiplier = 0
			let siblings = button.parentNode.childNodes
			for(let i = 0; i < siblings.length; ++i) {
				let sibling = siblings[i]
				if(sibling.nodeType != 1) {
					continue
				}
				if(sibling != button) {
					sibling.setAttribute("class", "")
				}
				if(sibling.getAttribute("class") == "selected") {
					multiplier = sibling.getAttribute("data-type") == "plus" ? 1 : -1
				}
			}

			let subject = parseInt(currentRow.getAttribute("data-subject"))
			let question = parseInt(currentRow.getAttribute("data-question"))
			let player = parseInt(button.getAttribute("data-player"))
			setCurrentAnswer(subject, question, player, multiplier)
		}

		function setCurrentAnswer(subject, question, player, multiplier) {
			let index = subject * 5 + question
			score[player][index] = multiplier

			let cell = document.querySelector("tr[data-subject='" + subject + "'][data-question='" + question + "'] td[data-player='" + player + "']")
			if(cell == undefined) {
				return
			}
			let sign = multiplier > 0 ? "+" : "−"
			let answerDescription = sign + (question + 1) * Math.abs(multiplier) * 10
			let answerClass = multiplier > 0 ? "positive" : "negative"
			cell.innerHTML = multiplier != 0 ? answerDescription : ""
			cell.setAttribute("class", answerClass)

			updateTotals(player)
		}

		function formatTotal(total, hardEarned) {
			if(total > 0) {
				return total
			} else if(total < 0) {
				return "−" + Math.abs(total)
			} else {
				return hardEarned ? "+0" : "0"
			}
		}

		function updateTotals(player) {
			let totalsCells = document.querySelectorAll("tr[class='score total'] td[data-player='" + player + "']")

			let grandTotal = 0
			let scored = false
			for(let i = 0; i < totalsCells.length; ++i) {
				let totalCell = totalsCells[i]
				let subject = parseInt(totalCell.getAttribute("data-subject"))

				let firstScoreIndex = subject * 5
				let lastScoreIndex = subject * 5 + 4
				let total = 0
				let scoredInSubject = false
				for(let scoreIndex = firstScoreIndex; scoreIndex <= lastScoreIndex; ++scoreIndex) {
					let question = scoreIndex % 5
					let multiplier = score[player][scoreIndex]
					if(multiplier == undefined || multiplier == 0) {
						continue
					}

					scored = true
					scoredInSubject = true

					total += (question + 1) * 10 * multiplier
				}
				totalCell.innerHTML = formatTotal(total, scoredInSubject)
				grandTotal += total
			}
			let grandTotalCell = document.querySelector("tr#grand-total td[data-player='" + player + "']")
			grandTotalCell.innerHTML = formatTotal(grandTotal, scored)
		}

		function getAnswer(subject, question, player) {
			let index = subject * 5 + question
			return score[player][index]
		}

		function onAvatarClicked(avatar) {
			let colors = ["red", "blue", "yellow", "green"]
			let color = avatar.getAttribute("data-color")
			let newColor = colors[(colors.indexOf(color) + 1) % 4]
			let player = parseInt(avatar.getAttribute("data-player"))
			avatar.setAttribute("data-color", newColor)
			localStorage.setItem("player" + player, newColor)
		}

		function loadAvatars() {
			let avatars = document.querySelectorAll(".avatar")
			for(let i = 0; i < avatars.length; ++i) {
				let avatar = avatars[i]
				let player = parseInt(avatar.getAttribute("data-player"))
				let color = localStorage.getItem("player" + player)
				if(color != undefined) {
					avatar.setAttribute("data-color", color)
				}
			}
		}

		function onNameFocus(textField) {
			textField.select()
		}

		function onNameBlur(textField) {
			textField.value = textField.value.replace(/\s+$/g,'');
		}

		function onNameKeyDown(textField) {
			if (event.key == "Enter") {
				textField.blur()
			}
		}

		window.addEventListener('load', function() {
			addSubject()
			loadAvatars()
		})
	</script>
</head>
<body>
	<table id="main" cellspacing="0">
		<tbody id="questions">
		</tbody>
		<tbody>
			<tr id="grand-total" class="score">
				<td>ΣΣ</td>
				<td data-player="0">0</td>
				<td data-player="1">0</td>
				<td data-player="2">0</td>
				<td data-player="3">0</td>
			</tr>
			<tr class="spacer">
				<td> </td>
			</tr>
		</tbody>
		<tbody id="avatars">
			<tr>
				<td></td>
				<td align="center">
					<div class="avatar" data-player="0" data-color="red" onclick="onAvatarClicked(this)"></div>
					<input type="text" value="Игрок 1" spellcheck="false" onfocus="onNameFocus(this)" onblur="onNameBlur(this)" onkeydown="onNameKeyDown(this)" />
				</td>
				<td align="center">
					<div class="avatar" data-player="1" data-color="blue" onclick="onAvatarClicked(this)"></div>
					<input type="text" value="Игрок 2" spellcheck="false" onfocus="onNameFocus(this)" onblur="onNameBlur(this)" onkeydown="onNameKeyDown(this)" />
				</td>
				<td align="center">
					<div class="avatar" data-player="2" data-color="yellow" onclick="onAvatarClicked(this)"></div>
					<input type="text" value="Игрок 3" spellcheck="false" onfocus="onNameFocus(this)" onblur="onNameBlur(this)" onkeydown="onNameKeyDown(this)" />
				</td>
				<td align="center">
					<div class="avatar" data-player="3" data-color="green" onclick="onAvatarClicked(this)"></div>
					<input type="text" value="Игрок 4" spellcheck="false" onfocus="onNameFocus(this)" onblur="onNameBlur(this)" onkeydown="onNameKeyDown(this)" />
				</td>
			</tr>
		</tbody>
	</table>

	<div id="controls">
		<table>
			<tr id="navigation">
				<td align="center">
					<button id="back" onclick="prevQuestion()">
						❮
					</button>
				</td>
				<td colspan="2" align="middle">
					<p><span id="current-subject-number">1.</span><span id="current-question-number">10</span></p>
				</td>
				<td align="center">
					<button id="next" onclick="nextQuestion()">
						❯
					</button>
				</td>
			</tr>
			<tr class="spacer">
				<td></td>
			</tr>
			<tr>
				<td align="center">
					<div class="action-buttons">
						<button onclick="onActionButtonClicked(this)" data-player="0" data-type="plus">+</button>
						<button onclick="onActionButtonClicked(this)" data-player="0" data-type="minus">−</button>
					</div>
				</td>
				<td align="center">
					<div class="action-buttons">
						<button onclick="onActionButtonClicked(this)" data-player="1" data-type="plus">+</button>
						<button onclick="onActionButtonClicked(this)" data-player="1" data-type="minus">−</button>
					</div>
				</td>
				<td align="center">
					<div class="action-buttons">
						<button onclick="onActionButtonClicked(this)" data-player="2" data-type="plus">+</button>
						<button onclick="onActionButtonClicked(this)" data-player="2" data-type="minus">−</button>
					</div>
				</td>
				<td align="center">
					<div class="action-buttons">
						<button onclick="onActionButtonClicked(this)" data-player="3" data-type="plus">+</button>
						<button onclick="onActionButtonClicked(this)" data-player="3" data-type="minus">−</button>
					</div>
				</td>
			</tr>
		</table>
	</div>
</body>
</html>
























